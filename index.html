<!DOCTYPE html>
<html lang="ar" dir="rtl" data-theme="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ø£Ø¯Ø§Ø© Ù…Ø®Ø·Ø· RACI Ø¨Ø³ÙŠØ·Ø©</title>
    
    <!-- Google Fonts for Arabic -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700&display=swap" rel="stylesheet">
    
    <!-- Pico.css for modern styling -->
    <link rel="stylesheet" href="https://unpkg.com/@picocss/pico@latest/css/pico.min.css">
    
    <!-- Grid.js theme -->
    <link href="https://unpkg.com/gridjs/dist/theme/mermaid.min.css" rel="stylesheet" />

    <!-- Custom Styles for a better look and feel -->
    <style>
        body {
            font-family: 'Cairo', sans-serif;
            padding: 1rem;
        }
        main.container {
            max-width: 1200px;
            margin: auto;
            padding: 2rem;
            border-radius: 1rem;
            box-shadow: 0 8px 30px rgba(0,0,0,0.1);
            background-color: var(--card-background-color);
        }
        h1, h2 {
            text-align: center;
            margin-bottom: 1.5rem;
            color: var(--h1-color);
        }
        .grid-container, .summary-container {
            margin-top: 2rem;
            margin-bottom: 2rem;
        }
        .controls {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 1rem;
            margin-top: 1.5rem;
        }
        button {
            cursor: pointer;
            transition: background-color 0.3s ease, transform 0.2s ease;
        }
        button:hover {
            transform: translateY(-2px);
        }
        #show-export-modal {
            background-color: #388E3C;
            border-color: #388E3C;
        }
        #show-export-modal:hover {
            background-color: #2E7D32;
        }
        .raci-select {
            width: 100%;
            padding: 8px;
            border-radius: 4px;
            border: 1px solid var(--form-element-border-color);
            background-color: var(--background-color);
        }
        .header-input {
            width: 100%;
            border: 2px solid var(--primary);
            padding: 5px;
            font-size: inherit;
            font-family: inherit;
            font-weight: bold;
            text-align: right;
        }
        .gridjs-th, .gridjs-td:first-child {
            cursor: pointer;
        }
        /* Role-based colors */
        .gridjs-td.role-r { background-color: rgba(85, 150, 200, 0.3) !important; }
        .gridjs-td.role-a { background-color: rgba(100, 180, 100, 0.3) !important; }
        .gridjs-td.role-c { background-color: rgba(240, 180, 80, 0.3) !important; }
        .gridjs-td.role-i { background-color: rgba(180, 180, 180, 0.3) !important; }
        
        .summary-container {
            border-top: 2px solid var(--muted-border-color);
            padding-top: 1.5rem;
        }
        .summary-filters {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            justify-content: center;
            margin-bottom: 1.5rem;
        }
        .summary-filters button {
            font-size: 0.9em;
            padding: 0.5rem 1rem;
        }
        .summary-filters button.active {
            background-color: var(--primary);
            color: var(--primary-inverse);
        }
        .summary-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 1.5rem;
        }
        .summary-member-card {
            border: 1px solid var(--muted-border-color);
            border-radius: 8px;
            padding: 1rem;
            background-color: var(--card-background-color);
        }
        .summary-member-card h4 {
            margin-top: 0;
            border-bottom: 2px solid var(--primary);
            padding-bottom: 0.5rem;
        }
        .summary-member-card ul {
            padding-right: 20px;
            margin-bottom: 0;
        }
        .summary-member-card li {
            margin-bottom: 0.25rem;
        }
        /* Export Modal Styles */
        dialog {
            width: 90%;
            max-width: 400px;
            border-radius: 8px;
            border: 1px solid var(--muted-border-color);
            padding: 1.5rem;
        }
        dialog::backdrop {
            background: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(3px);
        }
        dialog .grid {
            grid-template-columns: 1fr 1fr;
        }
    </style>
</head>
<body>
    <main class="container">
        <h1>Ø£Ø¯Ø§Ø© Ù…Ø®Ø·Ø· RACI</h1>
        <p style="text-align: center;">Ø­Ø¯Ø¯ Ø§Ù„Ø£Ø¯ÙˆØ§Ø± ÙˆØ§Ù„Ù…Ø³Ø¤ÙˆÙ„ÙŠØ§Øª Ù„Ù…Ù‡Ø§Ù… Ù…Ø´Ø±ÙˆØ¹Ùƒ.</p>
        
        <div class="grid">
            <input type="text" id="projectName" placeholder="Ø£Ø¯Ø®Ù„ Ø§Ø³Ù… Ø§Ù„Ù…Ø´Ø±ÙˆØ¹ Ø£Ùˆ Ø§Ù„Ù‚Ø§Ø¦Ø¯">
        </div>

        <div id="raci-grid" class="grid-container"></div>

        <div class="controls">
            <button id="addRow">Ø£Ø¶Ù Ù…Ù‡Ù…Ø©</button>
            <button id="addMember">Ø£Ø¶Ù Ø¹Ø¶Ùˆ</button>
            <button id="show-export-modal">ØªØµØ¯ÙŠØ± ÙƒÙ…Ù„Ù HTML</button>
        </div>

        <div id="summary-container" class="summary-container">
            <h2>Ù…Ù„Ø®Øµ Ø§Ù„Ø£Ø¯ÙˆØ§Ø± Ø­Ø³Ø¨ Ø§Ù„Ø¹Ø¶Ùˆ</h2>
            <div id="summary-filters" class="summary-filters"></div>
            <div id="summary-grid" class="summary-grid"></div>
        </div>
    </main>

    <!-- Export Modal Dialog -->
    <dialog id="export-modal">
        <h3 style="text-align:center;">Ø§Ø®ØªØ± Ù†ÙˆØ¹ Ø§Ù„ØªØµØ¯ÙŠØ±</h3>
        <p style="text-align:center;">Ø³ÙŠØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ù…Ù„Ù HTML Ù„Ù„Ø¹Ø±Ø¶ ÙÙ‚Ø·.</p>
        <div class="grid">
            <button id="export-draft" class="secondary">Ù…Ø³ÙˆØ¯Ø© (Draft)</button>
            <button id="export-final">Ù†Ù‡Ø§Ø¦ÙŠ (Final)</button>
        </div>
        <footer style="margin-top: 1rem;">
            <button id="close-modal" class="outline">Ø¥ØºÙ„Ø§Ù‚</button>
        </footer>
    </dialog>

    <!-- JavaScript Libraries -->
    <script src="https://unpkg.com/gridjs/dist/gridjs.umd.js"></script>
    
    <!-- Main Application Logic -->
    <script>
        const raciOptions = {
            '': 'Ø§Ø®ØªØ±...',
            'R': 'R - Ù…Ø³Ø¤ÙˆÙ„ ï¿½',
            'A': 'A - Ù…Ø³Ø§Ø¡Ù„ ğŸ‘‘',
            'C': 'C - Ù…Ø³ØªØ´Ø§Ø± ğŸ’¬',
            'I': 'I - Ù…ÙØ·Ù‘Ù„Ø¹ ğŸ“¨'
        };
        const roleClasses = { 'R': 'role-r', 'A': 'role-a', 'C': 'role-c', 'I': 'role-i' };

        // Function to create column definitions with formatters and attributes
        const createColumn = (id, name, index) => ({
            id: id,
            name: name,
            sort: true, // Enable sorting for all member columns
            formatter: (cell, row) => createRaciDropdown(cell, row, index),
            attributes: (cell, row, col) => {
                // FIX: Added a guard clause to prevent the "Cannot read properties of null" error.
                if (!row || !row.cells || !row.cells[col.index]) return { 'class': 'gridjs-td' };
                const cellValue = row.cells[col.index].data;
                if (cellValue && roleClasses[cellValue]) {
                    return { 'class': 'gridjs-td ' + roleClasses[cellValue] };
                }
            }
        });
        
        let columns = [
             {
                id: 'task',
                name: 'Ø§Ù„Ù…Ù‡Ù…Ø©',
                width: '250px',
                sort: true,
                formatter: (cell, row) => {
                    const rowIndex = data.findIndex(d => d === row.data);
                    // Use a wrapper div to attach a reliable index for editing
                    return gridjs.html(`<div class="editable-task" data-row-index="${rowIndex}">${cell}</div>`);
                }
            },
            createColumn('member1', 'Ø¹Ø¶Ùˆ Ø§Ù„ÙØ±ÙŠÙ‚ 1', 1),
            createColumn('member2', 'Ø¹Ø¶Ùˆ Ø§Ù„ÙØ±ÙŠÙ‚ 2', 2),
            createColumn('member3', 'Ø¹Ø¶Ùˆ Ø§Ù„ÙØ±ÙŠÙ‚ 3', 3),
        ];

        let data = [
            ['ØªØµÙ…ÙŠÙ… ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…', 'A', 'R', 'C'],
            ['ØªØ·ÙˆÙŠØ± Ø§Ù„ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ø£Ù…Ø§Ù…ÙŠØ©', 'I', 'A', 'R'],
            ['ØªØ·ÙˆÙŠØ± Ø§Ù„ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ø®Ù„ÙÙŠØ©', 'C', 'I', 'A'],
            ['Ø§Ù„Ù†Ø´Ø± Ø¹Ù„Ù‰ Ø§Ù„Ø®Ø§Ø¯Ù…', 'R', 'A', 'I'],
        ];

        let summaryRoleFilter = 'All';

        function createRaciDropdown(cell, row, cellIndex) {
            const rowIndex = data.findIndex(d => d === row.data);
            const selectedValue = row.cells[cellIndex].data || '';
            let optionsHtml = '';
            for (const [key, value] of Object.entries(raciOptions)) {
                optionsHtml += `<option value="${key}" ${key === selectedValue ? 'selected' : ''}>${value}</option>`;
            }
            return gridjs.html(`<select class="raci-select" data-row-index="${rowIndex}" data-cell-index="${cellIndex}">${optionsHtml}</select>`);
        }
        
        const grid = new gridjs.Grid({
            columns: columns,
            data: data,
            sort: true,
            search: { enabled: true },
            pagination: false,
            resizable: true,
            language: {
                'search': { 'placeholder': 'ğŸ” Ø§Ø¨Ø­Ø«...' },
                'pagination': {
                    'previous': 'Ø§Ù„Ø³Ø§Ø¨Ù‚', 'next': 'Ø§Ù„ØªØ§Ù„ÙŠ', 'showing': 'Ø¹Ø±Ø¶',
                    'to': 'Ø¥Ù„Ù‰', 'of': 'Ù…Ù†', 'results': 'Ù†ØªØ§Ø¦Ø¬'
                },
                'loading': 'Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...',
                'noRecordsFound': 'Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ù†ØªØ§Ø¦Ø¬',
                'error': 'Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø¬Ù„Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª'
            }
        }).render(document.getElementById('raci-grid'));
        
        function updateSummaryTable() {
            const summaryGrid = document.getElementById('summary-grid');
            summaryGrid.innerHTML = '';
            const summaryData = {};

            columns.slice(1).forEach(col => {
                summaryData[col.name] = { 'R': [], 'A': [], 'C': [], 'I': [] };
            });

            data.forEach(row => {
                const taskName = row[0];
                if (!taskName) return;
                row.slice(1).forEach((role, index) => {
                    const memberName = columns[index + 1].name;
                    if (role && summaryData[memberName] && summaryData[memberName][role]) {
                        summaryData[memberName][role].push(taskName);
                    }
                });
            });

            for (const memberName in summaryData) {
                const card = document.createElement('article');
                card.className = 'summary-member-card';
                let cardHtml = `<h4>${memberName}</h4>`;
                let hasRoles = false;
                
                const rolesToDisplay = summaryRoleFilter === 'All' 
                    ? Object.keys(summaryData[memberName])
                    : [summaryRoleFilter];

                for (const role of rolesToDisplay) {
                    if (!summaryData[memberName][role]) continue;
                    const tasks = summaryData[memberName][role];
                    if (tasks.length > 0) {
                        hasRoles = true;
                        cardHtml += `<h5>${raciOptions[role]}</h5><ul>`;
                        tasks.forEach(task => cardHtml += `<li>${task}</li>`);
                        cardHtml += `</ul>`;
                    }
                }
                if (!hasRoles) {
                    cardHtml += `<p>Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ù‡Ø§Ù… Ù…Ø¹ÙŠÙ†Ø© Ù„Ù‡Ø°Ø§ Ø§Ù„Ø¹Ø¶Ùˆ Ø¨Ø§Ù„ÙÙ„ØªØ± Ø§Ù„Ù…Ø­Ø¯Ø¯.</p>`;
                }
                card.innerHTML = cardHtml;
                summaryGrid.appendChild(card);
            }
        }

        function renderSummaryFilters() {
            const filtersContainer = document.getElementById('summary-filters');
            filtersContainer.innerHTML = '';
            const allRoles = { 'All': 'Ø§Ù„ÙƒÙ„', ...raciOptions };
            delete allRoles[''];

            for(const roleKey in allRoles) {
                const button = document.createElement('button');
                button.textContent = allRoles[roleKey];
                button.dataset.role = roleKey;
                if(summaryRoleFilter === roleKey) button.classList.add('active');
                button.addEventListener('click', () => {
                    summaryRoleFilter = roleKey;
                    renderSummaryFilters();
                    updateSummaryTable();
                });
                filtersContainer.appendChild(button);
            }
        }

        document.getElementById('addRow').addEventListener('click', () => {
            const newRow = Array(columns.length).fill('');
            data.push(newRow);
            grid.updateConfig({ data: data }).forceRender();
        });

        document.getElementById('addMember').addEventListener('click', () => {
            const newMemberIndex = columns.length;
            const newMemberName = `Ø¹Ø¶Ùˆ Ø§Ù„ÙØ±ÙŠÙ‚ ${newMemberIndex}`;
            columns.push(createColumn(`member${newMemberIndex}`, newMemberName, newMemberIndex));
            data.forEach(row => row.push(''));
            grid.updateConfig({ columns: columns, data: data }).forceRender();
        });

        document.getElementById('raci-grid').addEventListener('change', (e) => {
            if (e.target.classList.contains('raci-select')) {
                const select = e.target;
                const rowIndex = parseInt(select.dataset.rowIndex, 10);
                const cellIndex = parseInt(select.dataset.cellIndex, 10);
                if (!isNaN(rowIndex) && data[rowIndex]) {
                    data[rowIndex][cellIndex] = select.value;
                    grid.forceRender();
                }
            }
        });
        
        // --- Editable Cells and Headers ---
        document.getElementById('raci-grid').addEventListener('dblclick', (e) => {
            // Handle task editing
            const taskCell = e.target.closest('.editable-task');
            if (taskCell && !taskCell.querySelector('input')) {
                const rowIndex = parseInt(taskCell.dataset.rowIndex, 10);
                if (isNaN(rowIndex) || !data[rowIndex]) return;

                const currentText = data[rowIndex][0];
                const input = document.createElement('input');
                input.className = 'header-input';
                input.value = currentText;
                taskCell.innerHTML = '';
                taskCell.appendChild(input);
                input.focus();

                const finishEditing = () => {
                    const newText = input.value.trim();
                    if (newText) {
                        data[rowIndex][0] = newText;
                    }
                    grid.forceRender();
                };
                input.addEventListener('blur', finishEditing);
                input.addEventListener('keydown', (ev) => { if (ev.key === 'Enter') input.blur(); });
                return;
            }

            // Handle header editing
            const th = e.target.closest('th.gridjs-th');
            if (th && !th.querySelector('input')) {
                const contentDiv = th.querySelector('.gridjs-th-content');
                if (!contentDiv) return;

                const colId = th.dataset.columnId;
                const colIndex = columns.findIndex(c => c.id === colId);
                if (colIndex === -1 || colIndex === 0) return;

                const currentName = columns[colIndex].name;
                const input = document.createElement('input');
                input.className = 'header-input';
                input.value = currentName;
                contentDiv.innerHTML = '';
                contentDiv.appendChild(input);
                input.focus();

                const finishEditing = () => {
                    const newName = input.value.trim();
                    if (newName) {
                        columns[colIndex].name = newName;
                        grid.updateConfig({ columns: columns }).forceRender();
                    } else {
                         grid.forceRender();
                    }
                };
                input.addEventListener('blur', finishEditing);
                input.addEventListener('keydown', ev => { if (ev.key === 'Enter') ev.target.blur(); });
            }
        });

        function onReady() {
            renderSummaryFilters();
            updateSummaryTable();
        }

        grid.on('ready', onReady);
        grid.on('afterRender', () => {
            renderSummaryFilters();
            updateSummaryTable();
        });
        
        // --- Export Logic ---
        const exportModal = document.getElementById('export-modal');
        document.getElementById('show-export-modal').addEventListener('click', () => exportModal.showModal());
        document.getElementById('close-modal').addEventListener('click', () => exportModal.close());
        document.getElementById('export-draft').addEventListener('click', () => exportHTML('draft'));
        document.getElementById('export-final').addEventListener('click', () => exportHTML('final'));

        function exportHTML(exportType) {
            exportModal.close();
            const projectName = document.getElementById('projectName').value;
            const title = projectName ? `Ù…Ø®Ø·Ø· RACI - ${projectName}` : 'Ù…Ø®Ø·Ø· RACI Ø§Ù„ØªÙØ§Ø¹Ù„ÙŠ';
            
            const serializableColumns = columns.map(col => ({ id: col.id, name: col.name, width: col.width, sort: col.sort }));

            const watermarkText = exportType === 'draft' ? 'Ù…Ø³ÙˆØ¯Ø©' : 'Ù†Ù‡Ø§Ø¦ÙŠ';
            const watermarkColor = exportType === 'draft' ? 'rgba(255, 165, 0, 0.2)' : 'rgba(0, 128, 0, 0.2)';

            const watermarkStyle = `
                body::after {
                    content: '${watermarkText}';
                    position: fixed;
                    top: 50%;
                    left: 50%;
                    transform: translate(-50%, -50%) rotate(-45deg);
                    font-size: 10rem;
                    color: ${watermarkColor};
                    pointer-events: none;
                    z-index: 9999;
                    font-weight: bold;
                    opacity: 0.8;
                }
            `;

            const fileContent = `
<!DOCTYPE html>
<html lang="ar" dir="rtl" data-theme="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>${title}</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://unpkg.com/@picocss/pico@latest/css/pico.min.css">
    <link href="https://unpkg.com/gridjs/dist/theme/mermaid.min.css" rel="stylesheet" />
    <style>${document.querySelector('style').innerHTML}\n${watermarkStyle}</style>
</head>
<body>
    <main class="container">
        <h1>${title}</h1>
        <div id="raci-grid-view" class="grid-container"></div>
    </main>
    <script src="https://unpkg.com/gridjs/dist/gridjs.umd.js"><\/script>
    <script>
        const viewOnlyData = ${JSON.stringify(data)};
        const viewOnlyColumns = ${JSON.stringify(serializableColumns)};
        const roleClasses = ${JSON.stringify(roleClasses)};

        new gridjs.Grid({
            columns: viewOnlyColumns.map(col => {
                if(col.id === 'task') return col;
                return {
                    name: col.name,
                    sort: col.sort,
                    attributes: (cell, row, c) => {
                        if (!row) return;
                        const cellValue = row.cells[c.index].data;
                        if (cellValue && roleClasses[cellValue]) {
                            return { 'class': 'gridjs-td ' + roleClasses[cellValue] };
                        }
                    }
                }
            }),
            data: viewOnlyData,
            sort: true,
            pagination: false
        }).render(document.getElementById('raci-grid-view'));
    <\/script>
</body>
</html>`;

            const blob = new Blob([fileContent.trim()], { type: 'text/html' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = `${projectName.replace(/\s/g, '_') || 'raci-chart'}-${exportType}.html`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }
    </script>
</body>
</html>
ï¿½
